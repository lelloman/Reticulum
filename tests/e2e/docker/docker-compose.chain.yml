# Chain topology: A → T1 → T2 → D (3 hops)
# Tests multi-hop routing through a linear chain of transport nodes

services:
  transport:
    build:
      context: ../../../
      dockerfile: tests/e2e/docker/Dockerfile
    container_name: rns-transport
    hostname: transport
    volumes:
      - ./configs/transport/config:/root/.reticulum/config:ro
      - transport-storage:/root/.reticulum/storage
    networks:
      rns-e2e:
        ipv4_address: 172.28.0.10
    healthcheck:
      test: ["CMD", "rnstatus"]
      interval: 2s
      timeout: 5s
      retries: 15
      start_period: 3s

  transport-2:
    build:
      context: ../../../
      dockerfile: tests/e2e/docker/Dockerfile
    container_name: rns-transport-2
    hostname: transport-2
    volumes:
      - ./configs/transport-2/config:/root/.reticulum/config:ro
      - transport-2-storage:/root/.reticulum/storage
    networks:
      rns-e2e:
        ipv4_address: 172.28.0.15
    healthcheck:
      test: ["CMD", "rnstatus"]
      interval: 2s
      timeout: 5s
      retries: 15
      start_period: 3s

  node-a:
    build:
      context: ../../../
      dockerfile: tests/e2e/docker/Dockerfile
    container_name: rns-node-a
    hostname: node-a
    volumes:
      - ./configs/node-a/config:/root/.reticulum/config:ro
      - node-a-storage:/root/.reticulum/storage
    networks:
      rns-e2e:
        ipv4_address: 172.28.0.11
    depends_on:
      transport:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "rnstatus"]
      interval: 2s
      timeout: 5s
      retries: 15
      start_period: 3s

  node-d:
    build:
      context: ../../../
      dockerfile: tests/e2e/docker/Dockerfile
    container_name: rns-node-d
    hostname: node-d
    volumes:
      - ./configs/node-d/config:/root/.reticulum/config:ro
      - node-d-storage:/root/.reticulum/storage
    networks:
      rns-e2e:
        ipv4_address: 172.28.0.14
    depends_on:
      transport-2:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "rnstatus"]
      interval: 2s
      timeout: 5s
      retries: 15
      start_period: 3s

  # Connect transport to transport-2 for chain topology
  # This is done via a custom config that links T1 -> T2
  chain-link:
    build:
      context: ../../../
      dockerfile: tests/e2e/docker/Dockerfile
    container_name: rns-chain-link
    hostname: chain-link
    volumes:
      - chain-link-storage:/root/.reticulum/storage
    networks:
      rns-e2e:
        ipv4_address: 172.28.0.16
    depends_on:
      transport:
        condition: service_healthy
      transport-2:
        condition: service_healthy
    entrypoint: >
      sh -c "mkdir -p /root/.reticulum && cat > /root/.reticulum/config <<EOF
      [reticulum]
        enable_transport = yes
      [logging]
        loglevel = 4
      [interfaces]
        [[TCP to T1]]
          type = TCPClientInterface
          enabled = yes
          target_host = transport
          target_port = 4242
        [[TCP to T2]]
          type = TCPClientInterface
          enabled = yes
          target_host = transport-2
          target_port = 4242
      EOF
      exec rnsd -v"
    healthcheck:
      test: ["CMD", "rnstatus"]
      interval: 2s
      timeout: 5s
      retries: 15
      start_period: 3s

  test-runner:
    build:
      context: ../../../
      dockerfile: tests/e2e/docker/Dockerfile
    container_name: rns-test-runner
    volumes:
      - ../../../:/app:ro
      - /var/run/docker.sock:/var/run/docker.sock
      - ./results:/results
    networks:
      - rns-e2e
    depends_on:
      node-a:
        condition: service_healthy
      node-d:
        condition: service_healthy
      chain-link:
        condition: service_healthy
    environment:
      - TRANSPORT_HOST=transport
      - NODE_A_HOST=node-a
      - NODE_D_HOST=node-d
      - RESULTS_DIR=/results
      - TOPOLOGY=chain
    entrypoint: ["python", "-m", "pytest", "tests/e2e/scenarios/", "-v", "--tb=short", "-m", "topology_chain"]

networks:
  rns-e2e:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

volumes:
  transport-storage:
  transport-2-storage:
  node-a-storage:
  node-d-storage:
  chain-link-storage:
