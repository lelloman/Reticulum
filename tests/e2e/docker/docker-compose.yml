services:
  transport:
    build:
      context: ../../../
      dockerfile: tests/e2e/docker/Dockerfile
    container_name: rns-transport-${SHARD:-0}
    hostname: transport
    cap_add:
      - NET_ADMIN
    volumes:
      - ./configs/transport/config:/root/.reticulum/config:ro
      - transport-storage:/root/.reticulum/storage
    networks:
      rns-e2e:
        ipv4_address: 172.28.${SHARD:-0}.10
    healthcheck:
      test: ["CMD", "rnstatus"]
      interval: 2s
      timeout: 5s
      retries: 15
      start_period: 3s

  node-a:
    build:
      context: ../../../
      dockerfile: tests/e2e/docker/Dockerfile
    container_name: rns-node-a-${SHARD:-0}
    hostname: node-a
    cap_add:
      - NET_ADMIN
    volumes:
      - ./configs/node-a/config:/root/.reticulum/config:ro
      - node-a-storage:/root/.reticulum/storage
    networks:
      rns-e2e:
        ipv4_address: 172.28.${SHARD:-0}.11
    depends_on:
      transport:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "rnstatus"]
      interval: 2s
      timeout: 5s
      retries: 15
      start_period: 3s

  node-c:
    build:
      context: ../../../
      dockerfile: tests/e2e/docker/Dockerfile
    container_name: rns-node-c-${SHARD:-0}
    hostname: node-c
    cap_add:
      - NET_ADMIN
    volumes:
      - ./configs/node-c/config:/root/.reticulum/config:ro
      - node-c-storage:/root/.reticulum/storage
    networks:
      rns-e2e:
        ipv4_address: 172.28.${SHARD:-0}.12
    depends_on:
      transport:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "rnstatus"]
      interval: 2s
      timeout: 5s
      retries: 15
      start_period: 3s

  test-runner:
    build:
      context: ../../../
      dockerfile: tests/e2e/docker/Dockerfile
    container_name: rns-test-runner-${SHARD:-0}
    volumes:
      - ../../../:/app:ro
      - /var/run/docker.sock:/var/run/docker.sock
      - ./results:/results
    networks:
      - rns-e2e
    depends_on:
      node-a:
        condition: service_healthy
      node-c:
        condition: service_healthy
    environment:
      - TRANSPORT_HOST=transport
      - NODE_A_HOST=node-a
      - NODE_C_HOST=node-c
      - RESULTS_DIR=/results
      - TOPOLOGY=star
      - SHARD=${SHARD:-0}
    entrypoint: ["python", "-m", "pytest", "tests/e2e/scenarios/", "-v", "--tb=short", "-p", "no:cacheprovider"]

networks:
  rns-e2e:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.${SHARD:-0}.0/24

volumes:
  transport-storage:
  node-a-storage:
  node-c-storage:
